name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version/tag to deploy'
        required: true
        default: 'latest'

env:
  NODE_VERSION: '20.x'
  AZURE_WEBAPP_NAME: 'celora-web-prod'

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://app.celora.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests before production deploy
        run: npm test -- --ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create deployment package
        run: |
          tar -czf celora-production.tgz .next package.json package-lock.json public node_modules

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: celora-production.tgz

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to be live..."
          sleep 30
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app.celora.com)
          if [ $STATUS -eq 200 ]; then
            echo "‚úÖ Production deployment successful!"
          else
            echo "‚ùå Production deployment verification failed (HTTP $STATUS)"
            exit 1
          fi

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Production Release v${{ github.run_number }}
          body: |
            üöÄ Production deployment completed
            
            **Deployed version:** ${{ github.event.inputs.version }}
            **Commit:** ${{ github.sha }}
            **Deployed by:** ${{ github.actor }}
            **Deployment time:** ${{ github.event.head_commit.timestamp }}
            
            Changes in this release:
            ${{ github.event.head_commit.message }}

      - name: Logout from Azure
        run: az logout

      - name: Notify deployment
        run: |
          echo "üéâ ============================================"
          echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL!"
          echo "üåê URL: https://app.celora.com"
          echo "üì¶ Version: ${{ github.event.inputs.version }}"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "=============================================="

